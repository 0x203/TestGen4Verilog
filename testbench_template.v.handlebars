`timescale 1ps/1ps

module main;

    //TODO X:1 okay?

    // create regs for all outgoing signals
    reg reset;
    {{#each outgoing.signals}}
    reg {{name}};
    {{/each}}

    // create wires for all ingoing signals
    {{#each ingoing.signals}}
    wire {{name}};
    {{/each}}

    //create regs for all outgoing data-wires
    {{#each outgoing.data}}
    reg [{{width}}:1] {{name}};
    {{/each}}

    //create wires for all ingoing data-wires
    {{#each ingoing.data}}
    wire [{{width}}:1] {{name}};
    {{/each}}

    //instanciate uut
    // TODO!!!
    Balsa_gcd I0 (r1, a1, r2, a2, d2, r3, a3, d3, r4, a4, d4, reset);

    // set constants for all used data values
    {{#each events}}
    {{#if data}}
    req [{{dataWidthMinus1}}:0] testval{{@index}}_data{{channel}} = {{dataWidth}}'d{{data}};
    {{/if}}
    {{/each}}

    time start;

    // set the adjacency matrix
    reg [{{eventcountMinusOne}}:0]matrix[0:{{eventcountMinusOne}}] = '{
      {{#each matrix}}
        {{eventcount}}'b{{#each .}}{{.}}{{/each}}{{#if @last}} }; {{else}},
{{/if}}
      {{/each}}

    // set occured to the numer of events
    reg [0:{{eventcountMinusOne}}]occured = {{eventcount}}'b{{#each matrix}}1{{/each}};

    enum { idle, active, resetphase } handshake;

    initial begin
        $display("TB_START: %d,%d,%d", testval_d2, testval_d3, testval_d4);

        handshake = resetphase;
        #10000
        // set all outgoing signals to 0 and data to X
        {{#each outgoing.signals}}
        {{name}} = 0;
        {{/each}}
        {{#each outgoing.data}}
        {{name}} = {{width}}'bX;
        {{/each}}
        reset = 0;
        #50000 reset = 1;
        #50000 reset = 0;
        #50000;

        // check all ingoing signals to be 0
        if(
            {{#each ingoing.signals}}{{name}} !== 0{{#unless @last}} || {{/unless}}{{/each}}
        ) begin
            $display("TB_ERROR: reset; a1=%d, r2=%d, r3=%d, r4=%d", a1, r2, r3, r4);
            handshake = idle;
            $finish;
        end

        start = $time;
        handshake = active;
        doOutputs();

        wait(handshake == idle);
        $finish;
    end

    task doOutputs;
        bit didSomething;
    begin
        didSomething = 1;
        // for every outgoing signal render a block of this
        if (1 == 0) begin
            $display("I'll never happen. I'm just a dummy.");
        {{#each events}}
        {{#if activeSense}}
        end else if(
            ((matrix[{{@index}}] & occured) == 0) && occured[{{@index}}] == 1
        ) begin
            $display("TB_DEBUG (%d): out {{type}}{{channel}}+", $time);
            occured[{{@index}}] = 0;
            {{#if data}}
            // set data channel on predefined value
            data{{channel}} = testval{{@index}}_data{{channel}};
            {{/if}}
            {{#if channel}}
            // set handshake signal
            {{type}}{{channel}} = 1;
            {{/if}}
        {{/if}}
        {{/each}}
        end else begin
            didSomething = 0;
        end

        if(didSomething == 1) begin
            doOutputs();
        end
    end
    endtask

    //pos a1
    always @ (posedge a1) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in a1+", $time);
            if(((matrix[1] & occured) == 0) && occured[1] == 1) begin
                occured[1] = 0;
                if(occured !== 0) begin
                    $display("TB_ERROR: occured");
                    handshake = idle;
                end
                $display("TB_DEBUG (%d): out r1-", $time);
                r1 = 0;
            end else begin
                $display("TB_ERROR: a1+");
                handshake = idle;
            end
        end
    end

    //neg a1
    always @ (negedge a1) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in a1-", $time);
            if(a1===0 && r2===0 && r3===0 && r4===0) begin
                $display("TB_SUCCESS: %d", ($time-start));
                handshake = idle;
            end else begin
                $display("TB_ERROR: a1+ Signals");
                handshake = idle;
            end
        end
    end

    //pos r2
    always @ (posedge r2) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r2+", $time);
            if(((matrix[2] & occured) == 0) && occured[2] == 1) begin
                occured[2] = 0;
                doOutputs();
            end else begin
                $display("TB_ERROR: r2+");
                handshake = idle;
            end
        end
    end

    //neg r2
    always @ (negedge r2) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r2-", $time);
            if(a2 == 1) begin
                //d2 = 8'bZ;
                $display("TB_DEBUG (%d): out a2-", $time);
                a2 = 0;
            end else begin
                $display("TB_ERROR: r2-");
                handshake = idle;
            end
        end
    end

    //pos r3
    always @ (posedge r3) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r3+", $time);
            if(((matrix[4] & occured) == 0) && occured[4] == 1) begin
                occured[4] = 0;
                doOutputs();
            end else begin
                $display("TB_ERROR: r3+");
                handshake = idle;
            end
        end
    end

    //neg r3
    always @ (negedge r3) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r3-", $time);
            if(a3 == 1) begin
                //d3 = 8'bZ;
                $display("TB_DEBUG (%d): out a3-", $time);
                a3 = 0;
            end
            else begin
                $display("TB_ERROR: r3-");
                handshake = idle;
            end
        end
    end

    //pos r4
    always @ (posedge r4) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r4+, d4=%d", $time, d4);
            // $display("Matrix[6]: %b", matrix[6]);
            // $display("Schon gewesen: %b", occured);
            // $display("And: %b", matrix[6] & occured);
            if(((matrix[6] & occured) == 0) && occured[6] == 1) begin
                if(d4 == testval_d4) begin
                    occured[6] = 0;
                    doOutputs();
                end else begin
                    $display("TB_ERROR: d4 eval; %d != %d", testval_d4, d4);
                    handshake = idle;
                end
            end else begin
                $display("TB_ERROR: r4+");
                handshake = idle;
            end
        end
    end

    //neg r4
    always @ (negedge r4) begin
        if(handshake == active) begin
            $display("TB_DEBUG (%d): in r4-", $time);
            if(a4 == 1) begin
                $display("TB_DEBUG (%d): out a4-", $time);
                a4 = 0;
            end else begin
                $display("TB_ERROR: r4-");
                handshake = idle;
            end
        end
    end
endmodule
